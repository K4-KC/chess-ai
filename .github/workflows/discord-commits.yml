name: Notify Discord on key GitHub events

on:
  push:
    branches: [main, fen-logic, godot-cpp-dll]
  create:
    branches: ["**"]
  delete:
    branches: ["**"]
  pull_request:
    types: [opened, closed]

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Commits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  commit_notify:
    if: ${{ github.event_name == 'push' && github.event.head_commit != null }}
    runs-on: ubuntu-latest
    steps:
      # Fetch changed files list
      - name: Fetch changed files list
        uses: actions/github-script@v7
        id: filelist
        with:
          script: |
            const commit = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });
            return commit.data.files.map(f => `_${f.filename}_`).join("\n");
      - name: Notify commit to Discord
        uses: Sniddl/discord-commits@v1.6
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          message: |
            ğŸ“¢ **New commit** pushed to the branch: **_${{ github.ref_name }}_**
          embed: |
            {
              "author": {
                "name": "{{ commit.author.name }}",
                "icon_url": "https://github.com/{{ commit.author.username }}.png",
                "url": "https://github.com/{{ commit.author.username }}"
              },
              "title":       "{{ commit.title }}",
              "description": "{{ commit.description }}",
              "url":         "{{ commit.url }}",
              "fields": [
                {
                  "name":  "Files Changed",
                  "value": ${{ steps.filelist.outputs.result }},
                  "inline": false
                }
              ]
            }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Branch Create â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  branch_create_notify:
    if: ${{ github.event_name == 'create' && github.event.ref_type == 'branch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Notify branch creation to Discord
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"ğŸ“‚ **New branch created**: **_${{ github.event.ref }}_**\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Branch Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  branch_delete_notify:
    if: ${{ github.event_name == 'delete' && github.event.ref_type == 'branch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Notify branch deletion to Discord
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"ğŸ—‘ï¸ **Branch _${{ github.event.ref }}_ deleted**:\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pull Requests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pr_open_notify:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'opened' }}
    runs-on: ubuntu-latest
    steps:
      - name: Notify PR opened to Discord
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"ğŸ“¬ **Pull Request opened** #${{ github.event.pull_request.number }}: _${{ github.event.pull_request.title }}_ by **${{ github.event.pull_request.user.login }}**\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

  pr_closed_notify:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' }}
    runs-on: ubuntu-latest
    steps:
      - name: Notify PR closed/unmerged to Discord
        if: ${{ !github.event.pull_request.merged }}
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"âŒ **Pull Request closed** without merge: #${{ github.event.pull_request.number }}\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: Notify PR merged to Discord
        if: ${{ github.event.pull_request.merged }}
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"âœ… **Pull Request merged** #${{ github.event.pull_request.number }} by **${{ github.event.pull_request.merged_by.login }}**\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
